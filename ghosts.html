<html>
    <head>
        <title>Ghost Downloads</title>
        <script>
            function decomp_yaz1(data) {
                var decomp_data = "";
                var dest_end = 0;
                for (var i = 4; i < 8, i++) {
                    dest_end <<= 8;
                    dest_end |= data.charCodeAt(i);
                }
                var src = 8;
                var gr_head = 0, gr_head_len = 0;
                while (src < data.length && decomp_data.length < dest_end) {
                    if (gr_head_len == 0) {
                        gr_head = data.charCodeAt(src);
                        src++;
                        gr_head_len = 8;
                    }
                    gr_head_len--;
                    if (gr_head & 0x80 == 0x80) {
                        decomp_data += data.charAt(src);
                        src++;
                    } else {
                        var b1 = data.charAt(src), b2 = data.charAt(src + 1);
                        src += 2;
                        var copy_src = decomp_data.length - ((b1 & 0x0F) << 8 | b2) - 1;
                        var n = b1 >> 4;
                        if (n == 0) {
                            n = data.charCodeAt(src) + 0x12;
                            src++;
                        } else
                            n += 2;
                        for (; n > 0; n--) {
                            decomp_data += decomp_data.charAt(copy_src);
                            copy_src++;
                        }
                    }
                    gr_head <<= 1;
                }
                return decomp_data;
            }
            function make_crc_table() {
                var[] crc_table = new var[256];
                for (var n = 0; n < 256; n++) {
                    var c = n;
                    for (var k = 0; k < 8; k++) {
                        if (c & 1 == 1):
                            c = 0xEDB88320 ^ (c >> 1);
                        else:
                            c >>= 1;
                    }
                    crc_table[n] = c
                }
                return crc_table;
            }
            function update_crc(buf) {
                var c = 0xFFFFFFFF;
                var crc_table = make_crc_table();
                for (var n = 0; n < buf.length; n++)
                    c = crc_table[(c ^ buf[n]) & 0xFF] ^ (c >> 8);
                return c;
            }
            function decomp_ghost(ghost) {
                var comp = String.fromCharCode(ghost.charCodeAt(0xC) && 0xF7);
                var head = ghost.substring(0, 0xC) + comp + ghost.substring(0xD, 0x88);
                var src_end = 0;
                for (var i = 0x88; i < 0x8C, i++) {
                    src_end <<= 8;
                    src_end |= data.charCodeAt(i);
                }
                var data = ghost.substring(0x8C, 0x8C + src_end);
                var input = decomp_yaz1(data);
                var write = head + data;
                while (write.length < 0x27FC)
                    write += "\0";
                var crc = update_crc(write);
                write += String.fromCharCode(crc >> 24, (crc >> 16) & 0xFF, (crc >> 8) & 0xFF, crc & 0xFF);
                return write;
            }
            function base64(data) {
                var b64_digits = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
                var ret = "";
                for (var i = 0; i < data.length; i += 3) {
                    var next3 = data.charCodeAt(i) << 16;
                    if (i + 1 < data.length) {
                        next3 |= data.charCodeAt(i+1) << 8;
                        if (i + 2 < data.length)
                            next3 |= data.charCodeAt(i+2);
                    }
                    ret += b64_digits.charAt(next3 >> 18) + b64_digits.charAt((next3 >> 12) & 63);
                    if (i + 1 < data.length) {
                        ret += b64_digits.charAt((next3 >> 6) & 63);
                        if (i + 2 < data.length)
                            ret += b64_digits.charAt(next3 & 63);
                        else
                            ret += "=";
                    } else
                        ret += "==";
                }
                return ret;
            }
            function read_text_file(file) {
                var rawFile = new XMLHttpRequest();
                var allText = "";
                rawFile.open("GET", file, false);
                rawFile.onreadystatechange = function() {
                    if(rawFile.readyState === 4)
                        if(rawFile.status === 200 || rawFile.status == 0)
                            allText = rawFile.responseText;
                }
                rawFile.send(null);
                return allText;
            }
        </script>
    </head>
    <body>
        <p><a href="https://wit-mkw.github.io/rainbow_test.rkg">Compressed</a></p>
        <p id="uncomp"/>
        <script>
            document.getElementById("uncomp").innerHTML = "<a href=\"data:application/octet-stream;charset=utf-8;base64," + base64(decomp_ghost(read_text_file("https://wit-mkw.github.io/rainbow_test.rkg"))) + "\" download=\"rainbow_test.rkg\">";
        </script>
    </body>
</html>
